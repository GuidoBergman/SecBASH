FROM ubuntu:24.04

# 1.1: Install system dependencies (Python 3.10+, test tools, SSH, utilities)
# Note: python3-pip and python3-venv omitted -- uv handles all package management
RUN apt-get update && apt-get install -y \
    python3 \
    vim-tiny less man-db \
    git openssh-server \
    gettext-base \
    netcat-openbsd \
    gcc libc6-dev make \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# 1.2: Install uv package manager
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# 1.3: Install aegish (layer-cached: deps first, then source)
ENV UV_SYSTEM_PYTHON=1
ENV UV_BREAK_SYSTEM_PACKAGES=1
WORKDIR /opt/aegish-src
COPY pyproject.toml uv.lock README.md ./
COPY src/ src/
RUN uv pip install .

# 1.5: Register aegish as a valid login shell
RUN echo "$(which aegish)" >> /etc/shells

# 1.6: Create test user with aegish as login shell
RUN useradd -m -s "$(which aegish)" testuser && \
    echo "testuser:testpass" | chpasswd

# 1.6a: Grant testuser passwordless sudo (for sudo sandboxing tests)
RUN echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser && \
    chmod 440 /etc/sudoers.d/testuser

# 1.7: Configure SSH for login shell testing
# Use sed to ensure first-match-wins for PasswordAuthentication (sshd uses first match)
RUN mkdir /run/sshd && \
    sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# 1.8: Create production config file (root-owned, secure permissions)
# SSH sessions don't inherit Docker ENV vars, so security-critical settings
# must live in /etc/aegish/config (read by _load_config_file at startup).
RUN mkdir -p /etc/aegish && \
    printf '%s\n' \
        'AEGISH_MODE=production' \
        'AEGISH_FAIL_MODE=safe' \
        'AEGISH_ROLE=default' \
        'AEGISH_ALLOWED_PROVIDERS=openai,anthropic,groq,together_ai,ollama,gemini,featherless_ai,huggingface' \
        'AEGISH_VAR_CMD_ACTION=block' \
        'AEGISH_PRIMARY_MODEL=gemini/gemini-3-flash-preview' \
        'AEGISH_FALLBACK_MODELS=featherless_ai/trendmicro-ailab/Llama-Primus-Reasoning,openai/gpt-5-mini,anthropic/claude-haiku-4-5-20251001,anthropic/claude-sonnet-4-5-20250929,openai/gpt-5.1,anthropic/claude-opus-4-6,openai/gpt-5-nano,featherless_ai/fdtn-ai/Foundation-Sec-8B-Instruct' \
    > /etc/aegish/config && \
    chmod 644 /etc/aegish/config

# 1.9: Create audit log directory (writable by all users)
RUN mkdir -p /var/log/aegish && chmod 1733 /var/log/aegish

# 1.10: Build and install the Landlock sandboxer library
RUN cd /opt/aegish-src/src/sandboxer && make && make install

# Compute bash hash and embed in config (Story 17.2)
RUN BASH_HASH=$(sha256sum /bin/bash | cut -d' ' -f1) && \
    echo "AEGISH_BASH_HASH=${BASH_HASH}" >> /etc/aegish/config

# Compute sandboxer hash and embed in config (Story 17.8)
RUN SANDBOXER_HASH=$(sha256sum /opt/aegish/lib/landlock_sandboxer.so | cut -d' ' -f1) && \
    echo "AEGISH_SANDBOXER_HASH=${SANDBOXER_HASH}" >> /etc/aegish/config

# 1.11: Expose SSH port and start SSH daemon
EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
